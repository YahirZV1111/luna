<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Proyectos de Fabricaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0e0e0;
        }
        input, select, textarea, .block {
            color: #000205;
        }
    </style>
</head>

<script type="module">
  // Importar Firebase desde CDN (OBLIGATORIO en HTML)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    updateDoc, 
    deleteDoc, 
    doc, 
    onSnapshot 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // üî• TU CONFIGURACI√ìN DE FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyAoc4jHDHLOIPfZCzPqcgmGdWgpYXhIALw",
    authDomain: "control-fabricacion-1a73c.firebaseapp.com",
    projectId: "control-fabricacion-1a73c",
    storageBucket: "control-fabricacion-1a73c.firebasestorage.app",
    messagingSenderId: "773504427904",
    appId: "1:773504427904:web:b5eb6c074244f77efc4365"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);

  // Inicializar Firestore (BASE DE DATOS)
  const db = getFirestore(app);

  // Exportar db al scope global para que otros scripts lo puedan usar
  window.db = db;
  window.firebaseModules = {
    collection,
    addDoc,
    getDocs,
    updateDoc,
    deleteDoc,
    doc,
    onSnapshot
  };
  
  // üîé Solo para verificar que carg√≥ bien
  console.log("üî• Firebase y Firestore conectados correctamente");
  console.log("‚úÖ db disponible en window.db");
  console.log("‚úÖ firebaseModules disponible en window.firebaseModules");
  
  // Disparar evento para notificar que Firebase est√° listo
  window.firebaseReady = true;
  document.dispatchEvent(new Event('firebaseReady'));
</script>




<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-500 pb-2">Control de Tareas de Fabricaci√≥n</h1>

        <!-- Formulario de Ingreso de Datos -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4">Ingresar Nuevo Proyecto</h2>
            <form id="projectForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                <div class="col-span-full md:col-span-1">
                    <label for="nombreProyecto" class="block text-sm font-medium text-gray-700">NOMBRE DEL PROYECTO</label>
                    <input type="text" id="nombreProyecto" placeholder="Ej: ARCILLA, OVERLAND" required
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="col-span-full md:col-span-1">
                    <label for="descripcion" class="block text-sm font-medium text-gray-700">DESCRIPCI√ìN</label>
                    <input type="text" id="descripcion" placeholder="Ej: viga de 1/1, placa de 1/4" required
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="col-span-full md:col-span-1">
                    <label for="marca" class="block text-sm font-medium text-gray-700">MARCA</label>
                    <input type="text" id="marca" placeholder="Ej: ov-1, wt3"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="col-span-full md:col-span-1">
                    <label for="cantidad" class="block text-sm font-medium text-gray-700">CANTIDAD</label>
                    <input type="number" id="cantidad" placeholder="Ej: 10" min="0"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- APARTADO DEFECTOS: ahora inputs num√©ricos por defecto (count) -->
                <div class="col-span-full md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- DEFECTO DE HABILITADO -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Defecto de Habilitado (cantidad)</label>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm">FALTA DIMENSIONAR</span>
                                <input data-def-group="habilitado" data-def-name="FALTA DIMENSIONAR" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">SIN IDENTIFICACION</span>
                                <input data-def-group="habilitado" data-def-name="SIN IDENTIFICACION" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">FALTA DE BARRENTOS</span>
                                <input data-def-group="habilitado" data-def-name="FALTA DE BARRENTOS" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">FALTA DE LIMPIEZA</span>
                                <input data-def-group="habilitado" data-def-name="FALTA DE LIMPIEZA" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">DA√ëO MCANICO EN METALES BASE</span>
                                <input data-def-group="habilitado" data-def-name="DA√ëO MCANICO EN METALES BASE" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                        </div>
                    </div>

                    <!-- DEFECTO DE ARMADO -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Defecto de Armado (cantidad)</label>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm">FALTA DE ELEMENTOS</span>
                                <input data-def-group="armado" data-def-name="FALTA DE ELEMENTOS" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">PLACA CORRIDA</span>
                                <input data-def-group="armado" data-def-name="PLACA CORRIDA" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">MAL POSICIONADA</span>
                                <input data-def-group="armado" data-def-name="MAL POSICIONADA" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">GOLPE DE ARCO</span>
                                <input data-def-group="armado" data-def-name="GOLPE DE ARCO" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                        </div>
                    </div>

                    <!-- DEFECTO DE SOLDADURA -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Defecto de Soldadura (cantidad)</label>
                        <div class="space-y-2 max-h-56 overflow-auto pr-2">
                           
                            <div class="flex items-center justify-between"><span class="text-sm">CHISPORROTEO</span><input data-def-group="soldadura" data-def-name="CHISPORROTEO" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">DESGARE</span><input data-def-group="soldadura" data-def-name="DESGARE" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">ESCORIA</span><input data-def-group="soldadura" data-def-name="ESCORIA" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">FALTA DE FUSION</span><input data-def-group="soldadura" data-def-name="FALTA DE FUSION" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">DESALINIAMIENTO</span><input data-def-group="soldadura" data-def-name="DESALINIAMIENTO" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">TRASLAPE</span><input data-def-group="soldadura" data-def-name="TRASLAPE" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">REFUERZO DE SOLDADURA INSUFISIENTE</span><input data-def-group="soldadura" data-def-name="REFUERZO DE SOLDADURA INSUFISIENTE" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">POROSIDAD SUSPERFICIAL</span><input data-def-group="soldadura" data-def-name="POROSIDAD SUSPERFICIAL" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">CORDON DOBLADO / MAL ALINEADO</span><input data-def-group="soldadura" data-def-name="CORDON DOBLADO / MAL ALINEADO" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">CONVEXIDAD DE LA SLDADURA</span><input data-def-group="soldadura" data-def-name="CONVEXIDAD DE LA SLDADURA" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">GRIETA</span><input data-def-group="soldadura" data-def-name="GRIETA" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">SOCAVADO</span><input data-def-group="soldadura" data-def-name="SOCAVADO" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                            <div class="flex items-center justify-between"><span class="text-sm">AGRIETAMIENTO</span><input data-def-group="soldadura" data-def-name="AGRIETAMIENTO" type="number" min="0" value="0" class="w-20 p-1 border rounded" /></div>
                        </div>
                    </div>

                    <!-- DEFECTO DE TALADRO -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Defecto de Taladro (cantidad)</label>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm">TALADRO MAL DIMENSIONADO</span>
                                <input data-def-group="taladro" data-def-name="TALADRO MAL DIMENSIONADO" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">MAL TRAZO</span>
                                <input data-def-group="taladro" data-def-name="MAL TRAZO" type="number" min="0" value="0" class="w-20 p-1 border rounded" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-span-full lg:col-span-1">
                    <label for="habilitado" class="block text-sm font-medium text-gray-700">HABILITADO</label>
                    <select id="habilitado" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="OK">OK</option>
                    </select>
                </div>

                <div>
                    <label for="armado" class="block text-sm font-medium text-gray-700">ARMADO</label>
                    <select id="armado" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="OK">OK</option>
                    </select>
                </div>

                <div>
                    <label for="soldadura" class="block text-sm font-medium text-gray-700">SOLDADURA</label>
                    <select id="soldadura" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="OK">OK</option>
                    </select>
                </div>
                <div>
    <label for="taladros" class="block text-sm font-medium text-gray-700">TALADROS</label>
    <select id="taladros" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
        <option value="PENDIENTE">PENDIENTE</option>
        <option value="OK">OK</option>
    </select>
</div>
                <div>
    <label for="fechaArmado" class="block text-sm font-medium text-gray-700">Fecha Armado</label>
    <input type="date" id="fechaArmado" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
</div>

<!-- NUEVO: Fecha Habilitado -->
<div>
    <label for="fechaHabilitado" class="block text-sm font-medium text-gray-700">Fecha Habilitado</label>
    <input type="date" id="fechaHabilitado" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
</div>
 
<div>
    <label for="fechaSoldadura" class="block text-sm font-medium text-gray-700">Fecha Soldadura</label>
    <input type="date" id="fechaSoldadura" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
</div>

<div>
    <label for="fechaTaladros" class="block text-sm font-medium text-gray-700">Fecha Taladros</label>
    <input type="date" id="fechaTaladros" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
</div>

<!-- NUEVO: Fecha de Liberado -->
<div>
    <label for="fechaLiberado" class="block text-sm font-medium text-gray-700">Fecha Liberado</label>
    <input type="date" id="fechaLiberado" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
</div>
                

                <div>
                    <label for="liberado" class="block text-sm font-medium text-gray-700">LIBERADO</label>
                    <select id="liberado" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="OK">OK</option>
                    </select>
                </div>

                <div class="col-span-full flex items-end">
                    <button type="submit" id="saveButton"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:bg-indigo-400">
                        Guardar Proyecto
                    </button>
                </div>
            </form>
            <p id="error-message" class="text-red-500 mt-3 hidden"></p>
        </div>

        <!-- TABLA + BOTONES DE EXPORTACI√ìN/IMPORTACI√ìN -->
        <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                <h2 class="text-xl font-semibold text-gray-800">Lista de Proyectos Registrados</h2>
                <div class="space-x-2">
                    <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg shadow">Exportar Excel</button>
                    <button id="exportCsvBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg shadow">Exportar CSV</button>
                    <button id="importBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded-lg shadow">Importar CSV</button>
                </div>
            </div>
            
            <input type="file" id="fileInput" accept=".csv" class="hidden" />
            <a id="downloadLink" class="hidden"></a>

            <div id="loading" class="text-center text-indigo-500 py-4">Cargando proyectos...</div>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proyecto</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marca</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Habilitado</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Armado</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Soldadura</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Taladros</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Liberado</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Defectos</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Eliminar</th>
                    </tr>
                </thead>
                <tbody id="projectsTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>

        <div class="mt-4 text-sm text-gray-600">
            <p>ID de Usuario (para referencia): <span id="userIdDisplay" class="font-mono bg-gray-200 p-1 rounded-md text-xs">local-user</span></p>
        </div>

        <!-- Modal de Confirmaci√≥n para Eliminar -->
        <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar Eliminaci√≥n</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">¬øEst√°s seguro de que deseas eliminar este proyecto?</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 mr-2">
                            Eliminar
                        </button>
                        <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>





        
    (function(){
        const STORAGE_KEY = "proyectos_fabricacion_local_v1";

        // DOM elements
        const projectsTableBody = document.getElementById('projectsTableBody');
        const projectForm = document.getElementById('projectForm');
        const loadingElement = document.getElementById('loading');
        const errorMessageElement = document.getElementById('error-message');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');
        const downloadLink = document.getElementById('downloadLink');

        let projectIdToDelete = null;

        // Utility: generate ID
        function generateId() {
            return 'p_' + Math.random().toString(36).substr(2,9) + Date.now();
        }

        // Utility: format date ISO -> readable
        function formatDate(iso) {
            try {
                const d = new Date(iso);
                return d.toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch {
                return 'N/A';
            }
        }

        // Obtener instancia de Firestore - esperar a que est√© disponible
        let db, collection, addDoc, getDocs, updateDoc, deleteDoc, docRef, onSnapshot;
        
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.db && window.firebaseModules) {
                    db = window.db;
                    ({ collection, addDoc, getDocs, updateDoc, deleteDoc, doc: docRef, onSnapshot } = window.firebaseModules);
                    console.log("‚úÖ Firebase destructured correctamente");
                    resolve();
                } else {
                    console.log("‚è≥ Esperando Firebase...");
                    setTimeout(() => waitForFirebase().then(resolve), 50);
                }
            });
        }
        
        // Iniciar cuando Firebase est√© listo
        waitForFirebase().then(() => {
            initializeProjectApp();
        });

        function initializeProjectApp() {
        
        // Variable para almacenar proyectos actuales (para compatibilidad con c√≥digo existente)
        let currentProjects = [];

        // Funci√≥n para migrar datos viejos de localStorage a Firestore
        async function migrateOldData() {
            try {
                const oldData = localStorage.getItem(STORAGE_KEY);
                if (oldData) {
                    const projects = JSON.parse(oldData);
                    console.log(`Migrando ${projects.length} proyectos antiguos a Firestore...`);
                    
                    for (const project of projects) {
                        try {
                            await addDoc(collection(db, "proyectos"), project);
                        } catch (error) {
                            console.error("Error migrando proyecto:", error);
                        }
                    }
                    
                    // Eliminar datos viejos despu√©s de migrar
                    localStorage.removeItem(STORAGE_KEY);
                    console.log("‚úÖ Migraci√≥n completada. Datos viejos eliminados.");
                }
            } catch (error) {
                console.error("Error en migraci√≥n:", error);
            }
        }

        // Add project to Firestore
        async function addProject(project) {
            try {
                await addDoc(collection(db, "proyectos"), project);
                console.log("Proyecto guardado correctamente en Firebase");
            } catch (error) {
                console.error("Error al guardar proyecto en Firebase:", error);
                if (errorMessageElement) {
                    errorMessageElement.textContent = "Error al guardar el proyecto. Intenta de nuevo.";
                    errorMessageElement.classList.remove('hidden');
                }
            }
        }

        // Update a project field in Firestore
        async function updateProject(id, field, value) {
            try {
                const ref = docRef(db, "proyectos", id);
                const updateData = { [field]: value };
                
                // Agregar fechas autom√°ticamente seg√∫n el campo
                if(field === 'armado') updateData.fechaArmado = new Date().toISOString();
                if(field === 'soldadura') updateData.fechaSoldadura = new Date().toISOString();
                if(field === 'habilitado') updateData.fechaHabilitado = new Date().toISOString();
                if(field === 'taladros') updateData.fechaTaladros = new Date().toISOString();
                if(field === 'liberado') updateData.fechaLiberado = new Date().toISOString();
                
                await updateDoc(ref, updateData);
                return true;
            } catch (error) {
                console.error("Error al actualizar proyecto:", error);
                return false;
            }
        }


        // Delete project from Firestore
        async function deleteProjectLocal(id) {
            try {
                await deleteDoc(docRef(db, "proyectos", id));
                closeModal();
            } catch (error) {
                console.error("Error al eliminar proyecto:", error);
            }
        }

        // Render projects into the table
        function renderProjects(projects = currentProjects) {
            if (!projects || projects.length === 0) {
                projectsTableBody.innerHTML = `<tr><td colspan="12" class="p-4 text-center text-gray-500">No hay proyectos registrados a√∫n.</td></tr>`;
                if (loadingElement) loadingElement.classList.add('hidden');
                return;
            }
            if (loadingElement) loadingElement.classList.add('hidden');
            projectsTableBody.innerHTML = '';
            
            projects.forEach(project => {
                const date = project.fechaCreacion ? formatDate(project.fechaCreacion) : 'N/A';
                const getStatusClass = (status) => status === 'OK' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
                const row = document.createElement('tr');
                row.className = 'hover:bg-indigo-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-500">${date}</td>
                    <td class="px-3 py-3 whitespace-nowrap font-medium text-gray-900">${escapeHtml(project.nombre || '')}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${escapeHtml(project.descripcion || '')}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${escapeHtml(project.marca || '')}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${escapeHtml(String(project.cantidad !== undefined ? project.cantidad : ''))}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.habilitado)} cursor-pointer" 
                              data-field="habilitado" data-id="${project.id}">
                            ${project.habilitado || 'PENDIENTE'}
                        </span>
                        <br>
                        <span class="text-xs text-gray-400">
                            ${project.fechaHabilitado ? formatDate(project.fechaHabilitado) : ''}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.armado)} cursor-pointer"
                            data-field="armado" data-id="${project.id}">
                            ${project.armado}
                        </span>
                        <br>
                        <span class="text-xs text-gray-400">
                            ${project.fechaArmado ? formatDate(project.fechaArmado) : ''}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.soldadura)} cursor-pointer"
                        data-field="soldadura" data-id="${project.id}">
                        ${project.soldadura}
                    </span>
                        <br>
                        <span class="text-xs text-gray-400">
                            ${project.fechaSoldadura ? formatDate(project.fechaSoldadura) : ''}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.taladros)} cursor-pointer"
                            data-field="taladros" data-id="${project.id}">
                            ${project.taladros || 'PENDIENTE'}
                        </span>
                        <br>
                        <span class="text-xs text-gray-400">
                            ${project.fechaTaladros ? formatDate(project.fechaTaladros) : ''}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.liberado)} cursor-pointer" 
                              data-field="liberado" data-id="${project.id}">
                            ${project.liberado || 'PENDIENTE'}
                        </span>
                        <br>
                        <span class="text-xs text-gray-400">
                            ${project.fechaLiberado ? formatDate(project.fechaLiberado) : ''}
                        </span>
                    </td>

                    <!-- Mostrar defects agrupados por apartado -->
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600">
                        ${(() => {
                            const toEntries = (v) => {
                                // v puede ser objeto {name:count}, string "a:1;b:2" o array
                                if (!v) return [];
                                if (typeof v === 'object' && !Array.isArray(v)) return Object.entries(v);
                                if (Array.isArray(v)) return v.map(x => [x, 1]);
                                if (typeof v === 'string' && v.includes(':')) return v.split(';').map(s => s.trim()).filter(Boolean).map(pair => {
                                    const [k, val] = pair.split(':');
                                    return [k ? k.trim() : '', Number(val) || 1];
                                });
                                return [];
                            };

                            const h = toEntries(project.defectos_habilitado);
                            const a = toEntries(project.defectos_armado);
                            const s = toEntries(project.defectos_soldadura);
                            const t = toEntries(project.defectos_taladro);

                            const parts = [];
                            if (h.length) parts.push(`<div class="text-xs"><strong>Habilitado:</strong> ${escapeHtml(h.map(([k,v])`${k} (${v})`).join('; '))}</div>`);
                            if (a.length) parts.push(`<div class="text-xs"><strong>Armado:</strong> ${escapeHtml(a.map(([k,v])`${k} (${v})`).join('; '))}</div>`);
                            if (s.length) parts.push(`<div class="text-xs"><strong>Soldadura:</strong> ${escapeHtml(s.map(([k,v])`${k} (${v})`).join('; '))}</div>`);
                            if (t.length) parts.push(`<div class="text-xs"><strong>Taladro:</strong> ${escapeHtml(t.map(([k,v])`${k} (${v})`).join('; '))}</div>`);

                            return parts.join('');
                        })()}
                    </td>

                    <td class="px-3 py-3 whitespace-nowrap text-center text-sm font-medium">
                        <button data-id="${project.id}" class="delete-btn text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                projectsTableBody.appendChild(row);
            });
        }

        // Escape HTML to prevent injection
        function escapeHtml(unsafe) {
            return String(unsafe)
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
        }

       // Formatea objeto defects a string "defecto1:0;defecto2:1" (√∫til para export)
       function formatDefects(defs) {
           if (!defs || typeof defs !== 'object') return '';
           return Object.entries(defs)
               .map(([k, v]) => `${k}:${v}`)
               .join(';');
       }

      // Serializador gen√©rico para export (soporta object, array, string)
      function serializeDef(v) {
          if (!v) return '';
          if (typeof v === 'string') return v;
          if (Array.isArray(v)) return v.join(';');
          if (typeof v === 'object') return Object.entries(v).map(([k,val]) => `${k}:${val}`).join(';');
          return String(v);
      }
        // Toggle status when clicking on a status span
        projectsTableBody.addEventListener('click', (e) => {
            const statusTarget = e.target.closest('[data-field]');
            if (statusTarget) {
                const projectId = statusTarget.dataset.id;
                const field = statusTarget.dataset.field;
                const current = statusTarget.textContent.trim();
                const newStatus = current === 'OK' ? 'PENDIENTE' : 'OK';
                updateProject(projectId, field, newStatus);
            }
        });

        // Delegation for delete buttons
        projectsTableBody.addEventListener('click', (e) => {
            const del = e.target.closest('.delete-btn');
            if (del) {
                projectIdToDelete = del.dataset.id;
                openModal();
            }
        });

        // Form submit
        if (projectForm) {
            projectForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nombre = document.getElementById('nombreProyecto').value.trim();
                const descripcion = document.getElementById('descripcion').value.trim();
                const marca = document.getElementById('marca').value.trim();
                const cantidadVal = document.getElementById('cantidad').value.trim();
                const cantidad = cantidadVal === '' ? '' : Number(cantidadVal);
                const habilitado = document.getElementById('habilitado').value;
                const armado = document.getElementById('armado').value;
                const soldadura = document.getElementById('soldadura').value;
                const taladros = document.getElementById('taladros').value;
                const liberado = document.getElementById('liberado').value;

                // Leer defectos como contadores por defecto (object name->count)
                function collectDefects(groupName) {
                    const nodes = Array.from(document.querySelectorAll(`[data-def-group="${groupName}"]`));
                    const out = {};
                    nodes.forEach(n => {
                        const name = n.dataset.defName;
                        const val = Number(n.value) || 0;
                        if (val > 0) out[name] = val;
                    });
                    return out;
                }

                const defects_habilitado = collectDefects('habilitado');
                const defects_armado = collectDefects('armado');
                const defects_soldadura = collectDefects('soldadura');
                const defects_taladro = collectDefects('taladro');

                const newProject = {
                    id: generateId(),
                    nombre,
                    descripcion,
                    marca,
                    cantidad,
                    habilitado,
                    armado,
                    taladros,
                    soldadura,
                    liberado,
                    // guardamos objetos { defecto: cantidad }
                    defectos_habilitado: defects_habilitado,
                    defectos_armado: defects_armado,
                    defectos_soldadura: defects_soldadura,
                    defectos_taladro: defects_taladro,
                    fechaCreacion: new Date().toISOString(),
                    fechaHabilitado: document.getElementById("fechaHabilitado").value || "",
                    fechaArmado: document.getElementById("fechaArmado").value || "",
                    fechaSoldadura: document.getElementById("fechaSoldadura").value || "",
                    fechaTaladros: document.getElementById("fechaTaladros").value || "",
                    fechaLiberado: document.getElementById("fechaLiberado").value || ""
                };

                if (!nombre || !descripcion) {
                    if (errorMessageElement) {
                        errorMessageElement.textContent = "Por favor completa nombre y descripci√≥n.";
                        errorMessageElement.classList.remove('hidden');
                    }
                    return;
                }

                // Guardar en Firebase
                await addDoc(collection(db, "proyectos"), newProject);
                projectForm.reset();
                if (errorMessageElement) errorMessageElement.classList.add('hidden');
            });
        }

        // Modal handlers
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                if (projectIdToDelete) {
                    deleteProjectLocal(projectIdToDelete);
                }
            });
        }
        if (cancelDeleteBtn) {
            cancelDeleteBtn.addEventListener('click', closeModal);
        }

        function openModal() {
            deleteModal.classList.remove('hidden');
        }
        function closeModal() {
            deleteModal.classList.add('hidden');
            projectIdToDelete = null;
        }

        // ========== EXPORT / IMPORT FUNCTIONS ==========
        
        function exportarCSV() {
            const proyectos = currentProjects;
            if (proyectos.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }

            // serializar defectos por apartado antes de exportar
            const flat = proyectos.map(p => {
                const cp = Object.assign({}, p);
                cp.defectos_habilitado = serializeDef(p.defectos_habilitado);
                cp.defectos_armado = serializeDef(p.defectos_armado);
                cp.defectos_soldadura = serializeDef(p.defectos_soldadura);
                cp.defectos_taladro = serializeDef(p.defectos_taladro);
                cp.fechaHabilitado = cp.fechaHabilitado || '';
                cp.fechaLiberado = cp.fechaLiberado || '';
                cp.fechaCreacion = cp.fechaCreacion || '';
                cp.fechaArmado = cp.fechaArmado || '';
                cp.fechaSoldadura = cp.fechaSoldadura || '';
                cp.fechaTaladros = cp.fechaTaladros || '';
                return cp;
            });

            const encabezados = Object.keys(flat[0]).join(",");
            const filas = flat.map(p => Object.values(p).map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
            const contenido = encabezados + "\n" + filas;

            const blob = new Blob([contenido], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);

            downloadLink.href = url;
            downloadLink.download = "proyectos_" + new Date().toISOString().split('T')[0] + ".csv";
            downloadLink.click();
            URL.revokeObjectURL(url);
        }

        function exportarExcel() {
            const proyectos = currentProjects;
            if (proyectos.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }

            const flat = proyectos.map(p => {
                const cp = Object.assign({}, p);
                cp.defectos_habilitado = serializeDef(p.defectos_habilitado);
                cp.defectos_armado = serializeDef(p.defectos_armado);
                cp.defectos_soldadura = serializeDef(p.defectos_soldadura);
                cp.defectos_taladro = serializeDef(p.defectos_taladro);
                cp.fechaHabilitado = cp.fechaHabilitado || '';
                cp.fechaLiberado = cp.fechaLiberado || '';
                cp.fechaCreacion = cp.fechaCreacion || '';
                cp.fechaArmado = cp.fechaArmado || '';
                cp.fechaSoldadura = cp.fechaSoldadura || '';
                cp.fechaTaladros = cp.fechaTaladros || '';
                return cp;
            });

            let xml = `<?xml version="1.0"?>\n<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet">\n<Worksheet ss:Name="Proyectos">\n<Table>`;

            const headers = Object.keys(flat[0]);
            xml += "<Row>" + headers.map(h => `<Cell><Data ss:Type="String">${h}</Data></Cell>`).join("") + "</Row>";

            flat.forEach(p => {
                xml += "<Row>" + Object.values(p).map(v => `<Cell><Data ss:Type="String">${String(v)}</Data></Cell>`).join("") + "</Row>";
            });

            xml += "</Table></Worksheet></Workbook>";

            const blob = new Blob([xml], { type: "application/vnd.ms-excel" });
            const url = URL.createObjectURL(blob);

            downloadLink.href = url;
            downloadLink.download = "proyectos_" + new Date().toISOString().split('T')[0] + ".xls";
            downloadLink.click();
            URL.revokeObjectURL(url);
        }

        async function importarCSV(texto) {
            const lineas = texto.trim().split(/\r?\n/);
            if (lineas.length === 0) {
                alert("El archivo CSV est√° vac√≠o.");
                return;
            }

            const headers = lineas[0].split(",").map(h => h.replace(/"/g, "").trim());
            
            const proyectos = [];
            for (let i = 1; i < lineas.length; i++) {
                const cols = lineas[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
                const obj = {
                    id: generateId(),
                    fechaCreacion: new Date().toISOString()
                };
                headers.forEach((h, idx) => {
                    obj[h] = cols[idx] ? cols[idx].replace(/"/g, "").trim() : "";
                });
                proyectos.push(obj);
            }

            // Guardar todos los proyectos en Firestore
            let importCount = 0;
            for (const proyecto of proyectos) {
                try {
                    await addDoc(collection(db, "proyectos"), proyecto);
                    importCount++;
                } catch (error) {
                    console.error("Error al importar proyecto:", error);
                }
            }
            alert(`Se importaron ${importCount} proyectos correctamente.`);
        }

        // Event listeners for export/import buttons
        if (exportExcelBtn) {
            exportExcelBtn.addEventListener("click", exportarExcel);
        }
        
        if (exportCsvBtn) {
            exportCsvBtn.addEventListener("click", exportarCSV);
        }
        
        if (importBtn) {
            importBtn.addEventListener("click", () => {
                fileInput.click();
            });
        }

        if (fileInput) {
            fileInput.addEventListener("change", async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.name.endsWith(".csv")) {
                    const text = await file.text();
                    importarCSV(text);
                    fileInput.value = ''; // Reset input
                } else {
                    alert("Solo se admite formato CSV.");
                }
            });
        }

        // Inicializar con listener en tiempo real de Firestore
        // Primero migrar datos viejos
        migrateOldData().then(() => {
            console.log("Iniciando listener de Firestore...");
            
            onSnapshot(collection(db, "proyectos"), (snapshot) => {
                console.log(`üì¶ Firestore: ${snapshot.size} proyectos encontrados`);
                currentProjects = [];
                snapshot.forEach((docSnapshot) => {
                    currentProjects.push({ id: docSnapshot.id, ...docSnapshot.data() });
                });
                // Ordenar por fecha de creaci√≥n descendente
                currentProjects.sort((a, b) => {
                    const dateA = new Date(a.fechaCreacion || 0);
                    const dateB = new Date(b.fechaCreacion || 0);
                    return dateB - dateA;
                });
                renderProjects(currentProjects);
            }, (error) => {
                console.error("‚ùå Error al cargar proyectos desde Firebase:", error);
                console.error("C√≥digo de error:", error.code);
                console.error("Mensaje:", error.message);
            });
        });
        
        } // Fin de initializeProjectApp()
    </script>
</body>
</html>
