<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Proyectos de Fabricación</title>
    <!-- Carga de Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-500 pb-2">Control de Tareas de Fabricación</h1>
        
        <!-- Formulario de Ingreso de Datos -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-indigo-700 mb-4">Ingresar Nuevo Proyecto</h2>
            <form id="projectForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                
                <!-- NOMBRE DEL PROYECTO -->
                <div class="col-span-full md:col-span-1">
                    <label for="nombreProyecto" class="block text-sm font-medium text-gray-700">NOMBRE DEL PROYECTO</label>
                    <input type="text" id="nombreProyecto" placeholder="Ej: ARCILLA, OVERLAND" required
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- DESCRIPCION -->
                <div class="col-span-full md:col-span-1">
                    <label for="descripcion" class="block text-sm font-medium text-gray-700">DESCRIPCION</label>
                    <input type="text" id="descripcion" placeholder="Ej: viga de 1/1, placa de 1/4" required
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- MARCA -->
                <div class="col-span-full md:col-span-1">
                    <label for="marca" class="block text-sm font-medium text-gray-700">MARCA</label>
                    <input type="text" id="marca" placeholder="Ej: ov-1, wt3"
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <!-- HABILITADO - Usaremos una lista desplegable simple con la opción "OK" y "PENDIENTE" -->
                <div class="col-span-full lg:col-span-1">
                    <label for="habilitado" class="block text-sm font-medium text-gray-700">HABILITADO</label>
                    <select id="habilitado" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="OK">OK</option>
                    </select>
                </div>
                
                <!-- ARMADO -->
                <div>
                    <label for="armado" class="block text-sm font-medium text-gray-700">ARMADO</label>
                    <select id="armado" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="OK">OK</option>
                    </select>
                </div>

                <!-- SOLDADURA -->
                <div>
                    <label for="soldadura" class="block text-sm font-medium text-gray-700">SOLDADURA</label>
                    <select id="soldadura" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="OK">OK</option>
                    </select>
                </div>

                <!-- LIBERADO -->
                <div>
                    <label for="liberado" class="block text-sm font-medium text-gray-700">LIBERADO</label>
                    <select id="liberado" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2.5 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="OK">OK</option>
                    </select>
                </div>

                <!-- Botón de Guardar -->
                <div class="col-span-full flex items-end">
                    <button type="submit" id="saveButton"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:bg-indigo-400">
                        Guardar Proyecto
                    </button>
                </div>
            </form>
            <p id="error-message" class="text-red-500 mt-3 hidden"></p>
        </div>

        <!-- Tabla de Proyectos (Lista) -->
        <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Lista de Proyectos Registrados</h2>
            <div id="loading" class="text-center text-indigo-500 py-4">Cargando proyectos...</div>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proyecto</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marca</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Habilitado</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Armado</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Soldadura</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Liberado</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="projectsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Los proyectos se insertarán aquí -->
                </tbody>
            </table>
        </div>
        
        <!-- Mostrar ID de Usuario para referencia (MANDATORY) -->
        <div class="mt-4 text-sm text-gray-600">
            <p>ID de Usuario (para compartir): <span id="userIdDisplay" class="font-mono bg-gray-200 p-1 rounded-md text-xs">Cargando...</span></p>
        </div>
        
        <!-- Modal de Confirmación para Eliminar (Custom Modal) -->
        <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar Eliminación</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">¿Estás seguro de que deseas eliminar este proyecto?</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 mr-2">
                            Eliminar
                        </button>
                        <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Script de Firebase (MODULOS) -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Nivel de log para ver errores de Firestore
        setLogLevel('debug');

        // --- CONFIGURACIÓN DE FIREBASE Y AUTENTICACIÓN ---
        
        // Variables globales proporcionadas por el entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Elementos del DOM
        const projectsTableBody = document.getElementById('projectsTableBody');
        const projectForm = document.getElementById('projectForm');
        const saveButton = document.getElementById('saveButton');
        const loadingElement = document.getElementById('loading');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const errorMessageElement = document.getElementById('error-message');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        
        let projectIdToDelete = null;

        // Inicializar Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Error: Firebase configuration is missing.");
            errorMessageElement.textContent = "Error de configuración de Firebase.";
            errorMessageElement.classList.remove('hidden');
            saveButton.disabled = true;
        }
        
        // Manejo de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                isAuthReady = true;
                console.log("Usuario autenticado. UID:", userId);
                
                // Una vez autenticado, inicia la escucha de proyectos
                setupProjectsListener();
                
            } else {
                // Si no hay usuario, intenta iniciar sesión
                try {
                    if (initialAuthToken) {
                        // Usar el token personalizado si está disponible
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Si no, iniciar sesión anónimamente
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error de autenticación:", error);
                    errorMessageElement.textContent = "Error al iniciar sesión: " + error.message;
                    errorMessageElement.classList.remove('hidden');
                    saveButton.disabled = true;
                }
            }
        });

        // Función para obtener la ruta de la colección (privada por usuario)
        const getCollectionPath = () => {
            if (!userId) {
                console.error("Error: userId no está disponible.");
                return null;
            }
            // Ruta de la colección: /artifacts/{appId}/users/{userId}/proyectos_fabricacion
            return `artifacts/${appId}/users/${userId}/proyectos_fabricacion`;
        };

        // --- FUNCIONES DE MANEJO DE DATOS ---

        // 1. Guardar o Agregar Proyecto
        const saveProject = async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                console.warn("Autenticación no lista o user ID no disponible.");
                return;
            }
            
            const collectionPath = getCollectionPath();
            if (!collectionPath) return;

            const newProject = {
                nombre: document.getElementById('nombreProyecto').value.trim(),
                descripcion: document.getElementById('descripcion').value.trim(),
                marca: document.getElementById('marca').value.trim(),
                habilitado: document.getElementById('habilitado').value,
                armado: document.getElementById('armado').value,
                soldadura: document.getElementById('soldadura').value,
                liberado: document.getElementById('liberado').value,
                // Fecha de creación automática con el timestamp del servidor de Firestore
                fechaCreacion: serverTimestamp(),
            };

            saveButton.disabled = true;
            saveButton.textContent = "Guardando...";

            try {
                // Agregar un nuevo documento a la colección
                await addDoc(collection(db, collectionPath), newProject);
                projectForm.reset(); // Limpia el formulario
                errorMessageElement.classList.add('hidden');
            } catch (error) {
                console.error("Error al guardar el proyecto:", error);
                errorMessageElement.textContent = `Error al guardar: ${error.message}`;
                errorMessageElement.classList.remove('hidden');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = "Guardar Proyecto";
            }
        };

        // 2. Escucha de Proyectos en Tiempo Real (onSnapshot)
        const setupProjectsListener = () => {
            const collectionPath = getCollectionPath();
            if (!collectionPath) return;

            // Ordenar los proyectos por fecha de creación descendente (los más nuevos primero)
            const q = query(collection(db, collectionPath), orderBy("fechaCreacion", "desc"));
            
            onSnapshot(q, (snapshot) => {
                projectsTableBody.innerHTML = ''; // Limpiar la tabla
                loadingElement.classList.add('hidden'); // Ocultar el mensaje de carga

                if (snapshot.empty) {
                    projectsTableBody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-500">No hay proyectos registrados aún.</td></tr>`;
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const project = docSnap.data();
                    const projectId = docSnap.id;
                    
                    // Formatear la fecha
                    const date = project.fechaCreacion ? project.fechaCreacion.toDate().toLocaleDateString('es-MX', {
                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) : 'N/A';

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-indigo-50 transition duration-100';

                    // Función para obtener la clase de estilo para el estado
                    const getStatusClass = (status) => {
                        return status === 'OK' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
                    };

                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-500">${date}</td>
                        <td class="px-3 py-3 whitespace-nowrap font-medium text-gray-900">${project.nombre || ''}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${project.descripcion || ''}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${project.marca || ''}</td>
                        
                        <!-- Columna HABILITADO editable (con select) -->
                        <td class="px-3 py-3 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.habilitado)} cursor-pointer" 
                                  data-field="habilitado" data-id="${projectId}">
                                ${project.habilitado || 'PENDIENTE'}
                            </span>
                        </td>
                        
                        <!-- Columna ARMADO editable (con select) -->
                        <td class="px-3 py-3 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.armado)}" 
                                  data-field="armado" data-id="${projectId}">
                                ${project.armado || 'PENDIENTE'}
                            </span>
                        </td>
                        
                        <!-- Columna SOLDADURA editable (con select) -->
                        <td class="px-3 py-3 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.soldadura)}" 
                                  data-field="soldadura" data-id="${projectId}">
                                ${project.soldadura || 'PENDIENTE'}
                            </span>
                        </td>

                        <!-- Columna LIBERADO editable (con select) -->
                        <td class="px-3 py-3 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(project.liberado)}" 
                                  data-field="liberado" data-id="${projectId}">
                                ${project.liberado || 'PENDIENTE'}
                            </span>
                        </td>
                        
                        <!-- Columna Acciones -->
                        <td class="px-3 py-3 whitespace-nowrap text-center text-sm font-medium">
                            <button data-id="${projectId}" class="delete-btn text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    `;
                    projectsTableBody.appendChild(row);
                });
            }, (error) => {
                console.error("Error al escuchar proyectos:", error);
                loadingElement.textContent = "Error al cargar la lista. Revisa la consola.";
            });
        };

        // 3. Actualizar Estado (al hacer clic en el status)
        const toggleStatus = async (projectId, field, currentStatusElement) => {
            const collectionPath = getCollectionPath();
            if (!collectionPath) return;

            const newStatus = currentStatusElement.textContent.trim() === 'OK' ? 'PENDIENTE' : 'OK';
            
            // Crea un objeto con el campo a actualizar y su nuevo valor
            const updateData = {};
            updateData[field] = newStatus;

            try {
                const docRef = doc(db, collectionPath, projectId);
                await updateDoc(docRef, updateData);
                // No actualizamos la UI directamente, onSnapshot lo hará por nosotros.
            } catch (error) {
                console.error(`Error al actualizar el estado ${field} para el proyecto ${projectId}:`, error);
                alert(`Error al actualizar el estado: ${error.message}`);
            }
        };
        
        // 4. Eliminar Proyecto
        const deleteProject = async (projectId) => {
            const collectionPath = getCollectionPath();
            if (!collectionPath) return;

            try {
                await deleteDoc(doc(db, collectionPath, projectId));
            } catch (error) {
                console.error("Error al eliminar el proyecto:", error);
                alert(`Error al eliminar: ${error.message}`);
            } finally {
                closeModal();
            }
        };

        // --- MANEJO DE EVENTOS ---
        
        projectForm.addEventListener('submit', saveProject);

        // Delegación de eventos para los botones de eliminar y los spans de estado
        projectsTableBody.addEventListener('click', (e) => {
            const target = e.target.closest('.delete-btn');
            if (target) {
                projectIdToDelete = target.dataset.id;
                openModal();
                return;
            }
            
            const statusTarget = e.target.closest('[data-field]');
            if (statusTarget) {
                const projectId = statusTarget.dataset.id;
                const field = statusTarget.dataset.field;
                toggleStatus(projectId, field, statusTarget);
            }
        });
        
        // Manejo del modal
        confirmDeleteBtn.addEventListener('click', () => {
            if (projectIdToDelete) {
                deleteProject(projectIdToDelete);
            }
        });

        cancelDeleteBtn.addEventListener('click', closeModal);

        function openModal() {
            deleteModal.classList.remove('hidden');
        }

        function closeModal() {
            deleteModal.classList.add('hidden');
            projectIdToDelete = null;
        }

    </script>
</body>
</html>